<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>HSM-Tera | Customer</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: {
              50: '#ecfdf5', 100: '#d1fae5', 200: '#a7f3d0', 300: '#6ee7b7', 400: '#34d399', 500: '#10b981', 600: '#059669', 700: '#047857', 800: '#065f46', 900: '#064e3b'
            },
            success: '#10b981',
            danger: '#dc2626',
            warning: '#f59e0b'
          },
          boxShadow: {
            card: '0 10px 20px -10px rgba(16,185,129,0.25), 0 4px 12px -6px rgba(0,0,0,0.15)'
          }
        }
      }
    };
  </script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style> 
    html, body { 
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; 
    }

    /* Shining badge animations */
    @keyframes shine {
      0% { transform: translateX(-100%) skewX(-15deg); }
      100% { transform: translateX(200%) skewX(-15deg); }
    }

    @keyframes pulse-glow {
      0%, 100% { 
        box-shadow: 0 0 20px rgba(251, 191, 36, 0.4), 0 0 40px rgba(251, 191, 36, 0.2);
        transform: scale(1);
      }
      50% { 
        box-shadow: 0 0 30px rgba(251, 191, 36, 0.6), 0 0 60px rgba(251, 191, 36, 0.3);
        transform: scale(1.02);
      }
    }

    @keyframes sparkle {
      0%, 100% { opacity: 0; transform: scale(0.8); }
      50% { opacity: 1; transform: scale(1.2); }
    }

    .shining-badge {
      position: relative;
      overflow: hidden;
      background: linear-gradient(135deg, #fbbf24, #f59e0b);
      animation: pulse-glow 2s ease-in-out infinite;
    }

    .shining-badge::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(
        90deg,
        transparent,
        rgba(255, 255, 255, 0.4),
        transparent
      );
      animation: shine 3s ease-in-out infinite;
    }

    .shining-badge .sparkle {
      position: absolute;
      width: 4px;
      height: 4px;
      background: white;
      border-radius: 50%;
      animation: sparkle 1.5s ease-in-out infinite;
    }

    .shining-badge .sparkle:nth-child(1) {
      top: 20%;
      left: 20%;
      animation-delay: 0s;
    }

    .shining-badge .sparkle:nth-child(2) {
      top: 60%;
      right: 20%;
      animation-delay: 0.5s;
    }

    .winner-crown {
      background: linear-gradient(135deg, #ffd700 0%, #ffed4e 50%, #ffd700 100%);
      box-shadow: 0 4px 20px rgba(255, 215, 0, 0.4);
    }

    .shining-badge .sparkle:nth-child(3) {
      bottom: 20%;
      left: 50%;
      animation-delay: 1s;
    }

    /* Amount card animations */
    @keyframes countUp {
      0% { opacity: 0.7; }
      50% { opacity: 1; }
      100% { opacity: 1; }
    }

    .amount-counting {
      animation: countUp 0.1s ease-in-out;
    }

    /* Tooltip styles */
    .payment-tooltip {
      position: relative;
      cursor: help;
    }

    .payment-tooltip::before {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.9);
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 12px;
      white-space: nowrap;
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s ease;
      z-index: 1000;
      max-width: 200px;
      white-space: normal;
      text-align: center;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .payment-tooltip::after {
      content: '';
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%) translateY(100%);
      border: 5px solid transparent;
      border-top-color: rgba(0, 0, 0, 0.9);
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s ease;
      z-index: 1000;
    }

    .payment-tooltip:hover::before,
    .payment-tooltip:hover::after {
      opacity: 1;
      visibility: visible;
    }
  </style>
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' https://cdn.tailwindcss.com https://fonts.googleapis.com https://fonts.gstatic.com; script-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com;">
  <script src="../components/navbar.js"></script>
</head>
<body class="min-h-screen bg-gradient-to-b from-emerald-50 via-white to-white transition-opacity duration-300 opacity-0">
  <!-- Navbar Container -->
  <div id="navbar-container"></div>

  <main class="max-w-7xl mx-auto px-4 py-8 space-y-6">
    <div class="flex items-start justify-between gap-4">
      <div class="flex-1">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            <h1 id="customerName" class="text-xl font-semibold text-slate-800">Loading...</h1>
            <div id="shiningBadge" class="hidden">
              <div class="shining-badge inline-flex items-center gap-2 px-3 py-1.5 rounded-full text-white text-sm font-medium">
                <div class="sparkle"></div>
                <div class="sparkle"></div>
                <div class="sparkle"></div>
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                </svg>
                <span>Fully Paid</span>
              </div>
            </div>
            <div id="winnerBadge" class="hidden">
              <div class="shining-badge inline-flex items-center gap-2 px-3 py-1.5 rounded-full text-white text-sm font-medium">
                <div class="sparkle"></div>
                <div class="sparkle"></div>
                <div class="sparkle"></div>
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                </svg>
                <span id="winnerPosition">Winner</span>
              </div>
            </div>
          </div>
        </div>
        <p id="customerAddress" class="text-slate-600 text-sm mt-1">Loading address...</p>
        <p id="customerDetails" class="text-slate-500 text-sm mt-1">Loading customer details...</p>
        
        <!-- Winner Details Card -->
        <div id="winnerDetailsCard" class="hidden mt-4 bg-white border border-yellow-200 rounded-xl shadow-lg overflow-hidden">
          <!-- Header Section -->
          <div class="bg-gradient-to-r from-yellow-500 to-amber-500 px-6 py-4">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-3">
                <div class="winner-crown p-2 rounded-lg bg-white/20">
                  <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                  </svg>
                </div>
                <div>
                  <h3 class="text-lg font-bold text-white" id="winnerTitle">Winner Details</h3>
                  <p class="text-sm text-yellow-100" id="winnerMonthYear">Month/Year</p>
                </div>
              </div>
              <div class="text-right">
                <p class="text-xs text-yellow-100 font-medium">Gold Rate (1 gram)</p>
                <p class="text-lg font-bold text-white" id="winnerGoldRate">₹0</p>
              </div>
            </div>
          </div>
          
          <!-- Content Section -->
          <div class="p-6">
            <!-- Financial Overview -->
            <div class="mb-6">
              <h4 class="text-sm font-semibold text-slate-700 mb-3 flex items-center gap-2">
                <svg class="w-4 h-4 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"/>
                </svg>
                Financial Overview
              </h4>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="bg-slate-50 rounded-lg p-4 border border-slate-200">
                  <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
                      <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"/>
                      </svg>
                    </div>
                    <div>
                      <p class="text-xs text-slate-600 font-medium">Total Collections</p>
                      <p class="text-lg font-bold text-slate-800" id="winnerTotalCollections">₹0</p>
                    </div>
                  </div>
                </div>
                <div class="bg-slate-50 rounded-lg p-4 border border-slate-200">
                  <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                      <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3a2 2 0 012-2h4a2 2 0 012 2v4m-6 0h6m-6 0v10a2 2 0 002 2h4a2 2 0 002-2V7M8 7H6a2 2 0 00-2 2v10a2 2 0 002 2h2M8 7h8"/>
                      </svg>
                    </div>
                    <div>
                      <p class="text-xs text-slate-600 font-medium">Monthly Amount</p>
                      <p class="text-lg font-bold text-slate-800" id="winnerMonthlyAmount">₹0</p>
                    </div>
                  </div>
                </div>
                <div class="bg-slate-50 rounded-lg p-4 border border-slate-200">
                  <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-yellow-100 rounded-lg flex items-center justify-center">
                      <svg class="w-5 h-5 text-yellow-600" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                      </svg>
                    </div>
                    <div>
                      <p class="text-xs text-slate-600 font-medium">Winning Amount</p>
                      <p class="text-lg font-bold text-slate-800" id="winnerAmount">₹0</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Delivery Status -->
            <div class="mb-6">
              <h4 class="text-sm font-semibold text-slate-700 mb-3 flex items-center gap-2">
                <svg class="w-4 h-4 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
                </svg>
                Delivery Status
              </h4>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="bg-slate-50 rounded-lg p-4 border border-slate-200">
                  <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-emerald-100 rounded-lg flex items-center justify-center">
                      <svg class="w-5 h-5 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                      </svg>
                    </div>
                    <div>
                      <p class="text-xs text-slate-600 font-medium">Delivered Amount</p>
                      <p class="text-lg font-bold text-slate-800" id="winnerDelivered">₹0 / ₹0</p>
                    </div>
                  </div>
                </div>
                <div class="bg-slate-50 rounded-lg p-4 border border-slate-200">
                  <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-orange-100 rounded-lg flex items-center justify-center">
                      <svg class="w-5 h-5 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                      </svg>
                    </div>
                    <div>
                      <p class="text-xs text-slate-600 font-medium">Remaining Balance</p>
                      <p class="text-lg font-bold text-slate-800" id="winnerRemaining">₹0</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Status and Action Section -->
            <div class="border-t border-slate-200 pt-4">
              <div class="flex flex-col sm:flex-row items-center justify-between gap-4">
                <div id="deliveryStatus" class="flex items-center gap-2">
                  <span id="deliveryCompleted" class="hidden inline-flex items-center gap-2 px-4 py-2 bg-green-100 text-green-800 rounded-lg text-sm font-medium border border-green-200">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    Delivery Completed
                  </span>
                  <span id="deliveryPending" class="hidden inline-flex items-center gap-2 px-4 py-2 bg-orange-100 text-orange-800 rounded-lg text-sm font-medium border border-orange-200">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    Pending Delivery
                  </span>
                </div>
                <button id="addDeliveryBtn" class="hidden inline-flex items-center gap-2 px-4 py-2 bg-yellow-600 text-white rounded-lg text-sm font-medium hover:bg-yellow-700 transition-colors shadow-md border border-yellow-700">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                  </svg>
                  Add Delivery
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Amount Collected Card - Aligned with details -->
      <div class="relative overflow-hidden rounded-xl bg-gradient-to-br from-brand-500 via-brand-600 to-brand-700 px-4 py-3 shadow-lg">
        <div class="absolute inset-0 bg-gradient-to-br from-white/10 to-transparent"></div>
        <div class="relative flex items-center gap-3">
          <div class="flex items-center justify-center w-8 h-8 bg-white/20 rounded-full backdrop-blur-sm">
            <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
            </svg>
          </div>
          <div class="text-center">
            <p class="text-brand-100 text-xs font-medium">Total Collected</p>
            <p id="totalAmountCollected" class="text-lg font-bold text-white">₹ 0</p>
            <p id="paymentCount" class="text-brand-200 text-xs">0 payments</p>
          </div>
        </div>
        <div class="absolute bottom-0 left-0 right-0 h-0.5 bg-gradient-to-r from-white/30 via-white/20 to-transparent"></div>
      </div>

      <div id="customerInfoSection" class="text-right space-y-2">
        <div class="text-sm text-slate-500">Monthly Amount</div>
        <div id="monthlyAmount" class="text-2xl font-semibold">₹ 0</div>
        <div id="programDetails" class="text-xs text-slate-500">Loading program details...</div>
        <div class="flex gap-2">
          <a id="addPaymentBtn" href="add-payment.html" class="inline-flex items-center rounded-lg bg-brand-600 text-white px-3 py-1.5 text-sm shadow-card hover:bg-brand-700">Add Payment</a>
          <div id="markWinnerBtn" class="hidden">
            <button class="inline-flex items-center gap-2 px-3 py-1.5 bg-brand-600 text-white rounded-lg text-sm font-medium hover:bg-brand-700 transition-colors">
              <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
              </svg>
              Mark as Winner
            </button>
          </div>
        </div>
      </div>
    </div>

    <section id="timelineSection" class="bg-white rounded-2xl border border-slate-100 p-6 shadow-card">
      <div class="flex items-center justify-between mb-4">
        <h2 id="timelineTitle" class="font-medium text-slate-800">30-Month Payment Timeline</h2>
        <div id="timelineLegend" class="flex items-center gap-3 text-sm">
          <span class="inline-flex items-center gap-1"><span class="h-3 w-3 rounded-full bg-green-500 inline-block"></span> Paid</span>
          <span class="inline-flex items-center gap-1"><span class="h-3 w-3 rounded-full bg-red-500 inline-block"></span> Unpaid</span>
        </div>
      </div>
      <div id="calendarGrid" class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div class="col-span-full text-center py-8 text-slate-500">Loading payment timeline...</div>
      </div>
    </section>
  </main>

  <!-- Winner Marking Modal -->
  <div id="winnerModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
    <div class="flex items-center justify-center min-h-screen p-4">
      <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full">
        <div class="p-6">
          <div class="flex items-center justify-between mb-6">
            <div class="flex items-center gap-3">
              <div class="winner-crown p-2 rounded-lg">
                <svg class="w-6 h-6 text-yellow-600" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                </svg>
              </div>
              <h3 class="text-lg font-semibold text-slate-800">Mark as Winner</h3>
            </div>
            <button type="button" id="closeWinnerModal" class="text-slate-400 hover:text-slate-600">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
          </div>
          
          <form id="winnerForm" class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-2">Select Month/Year</label>
              <select id="winnerMonthYearSelect" name="monthYear" required
                      class="w-full px-4 py-3 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-transparent">
                <option value="">Select a month...</option>
              </select>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-2">Gold Rate (1 gram)</label>
              <input type="number" id="goldRate" name="goldRate" required min="1" step="0.01"
                     class="w-full px-4 py-3 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-transparent"
                     placeholder="Enter current gold rate">
            </div>
            
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-2">Winning Amount</label>
              <input type="number" id="winningAmount" name="winningAmount" required min="1" step="0.01"
                     class="w-full px-4 py-3 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-transparent"
                     placeholder="Enter winning amount">
            </div>
            
            <div class="flex gap-3 pt-4">
              <button type="button" id="cancelWinner" class="flex-1 px-4 py-2 bg-slate-100 text-slate-700 rounded-lg hover:bg-slate-200 transition-colors font-medium">
                Cancel
              </button>
              <button type="submit" class="flex-1 px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 transition-colors font-medium flex items-center justify-center gap-2">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                </svg>
                Mark as Winner
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Delivery Modal -->
  <div id="deliveryModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
    <div class="flex items-center justify-center min-h-screen p-4">
      <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full">
        <div class="p-6">
          <div class="flex items-center justify-between mb-6">
            <h3 class="text-lg font-semibold text-slate-800">Add Delivery</h3>
            <button type="button" id="closeDeliveryModal" class="text-slate-400 hover:text-slate-600">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
          </div>
          
          <form id="deliveryForm" class="space-y-4">
            <input type="hidden" id="winnerId" name="winnerId">
            
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-2">Bill Number</label>
              <input type="text" id="billNumber" name="billNumber" required
                     class="w-full px-4 py-3 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-transparent">
            </div>
            
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-2">Delivery Amount</label>
              <input type="number" id="deliveryAmount" name="deliveryAmount" required min="1"
                     class="w-full px-4 py-3 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-transparent">
            </div>
            
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-2">Remaining Balance</label>
              <input type="text" id="remainingBalance" readonly
                     class="w-full px-4 py-3 border border-slate-200 rounded-xl bg-slate-50 text-slate-600">
            </div>
            
            <div class="flex gap-3 pt-4">
              <button type="button" id="cancelDelivery" class="flex-1 px-4 py-2 bg-slate-100 text-slate-700 rounded-lg hover:bg-slate-200 transition-colors font-medium">
                Cancel
              </button>
              <button type="submit" class="flex-1 px-4 py-2 bg-brand-600 text-white rounded-lg hover:bg-brand-700 transition-colors font-medium">
                Add Delivery
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Fade in animation
    (function() {
      const prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
      function fadeIn() {
        if (prefersReduced) return document.body.classList.remove('opacity-0');
        requestAnimationFrame(() => document.body.classList.remove('opacity-0'));
      }
      document.addEventListener('DOMContentLoaded', fadeIn);
    })();

    // Animated counter
    (function() {
      const prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
      function animateCount(el) {
        const target = parseFloat(el.getAttribute('data-countup-value') || '0');
        const prefix = el.getAttribute('data-countup-prefix') || '';
        const duration = 900; // ms
        const start = performance.now();
        function step(now) {
          const progress = Math.min(1, (now - start) / duration);
          const ease = 1 - Math.pow(1 - progress, 3);
          const value = Math.floor(target * ease);
          el.textContent = `${prefix}${value.toLocaleString('en-IN')}`;
          if (progress < 1) requestAnimationFrame(step);
        }
        requestAnimationFrame(step);
      }
      function initCountups() {
        if (prefersReduced) return;
        document.querySelectorAll('[data-countup]').forEach(animateCount);
      }
      window.initCountups = initCountups; // Make it globally accessible
      window.addEventListener('DOMContentLoaded', initCountups);
    })();

    // Global variables
    let customerData = null;
    let paymentsData = [];
    let defaultStartDate = '2024-12-15';

    // Show customer data immediately (fallback)
    function showCustomerData() {
      console.log('Customer page: Showing fallback customer data...');
      
      // Get customer ID from URL
      const customerId = getCustomerIdFromUrl();
      
      // Set fallback customer data based on known customers
      customerData = getFallbackCustomerData(customerId);
      
      console.log('Customer page: Using fallback customer data:', customerData);
      
      // Update UI immediately
      updateCustomerInfo();
      generatePaymentTimeline();
      updateAmountCollectedCard();
    }

    // Get customer ID from URL parameters
    function getCustomerIdFromUrl() {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get('id') || '3';
    }

    // Get fallback customer data based on ID
    function getFallbackCustomerData(customerId) {
      // Return minimal fallback data - real data will be loaded from database
      return {
        id: customerId,
        name: 'Loading...',
        phone: 'Loading...',
        address: 'Loading...',
        start_date: '2024-12-15',
        monthly_amount: 0,
        customer_code: `GD7- ${customerId}`
      };
    }

    // Load customer data from API
    async function loadCustomerData() {
      try {
        console.log('Customer page: Loading customer data from API...');
        
        const customerId = getCustomerIdFromUrl();
        
        // Load default start date from environment
        await loadDefaultStartDate();
        
        // Load customer data from API
        const customerResult = await loadCustomerFromAPI(customerId);
        
        // Load payments data
        await loadPaymentsFromAPI(customerId);
        
        // Update UI with real data
        updateCustomerInfo();
        generatePaymentTimeline();
        updateAmountCollectedCard();
        
        console.log('Customer page: Data loading completed successfully');
        
      } catch (error) {
        console.error('Customer page: Error loading customer data:', error);
        // Don't show error to user, fallback data is already displayed
      }
    }

    // Load default start date from environment
    async function loadDefaultStartDate() {
      try {
        if (window.electronAPI && window.electronAPI.getDefaultStartDate) {
          defaultStartDate = await window.electronAPI.getDefaultStartDate();
          console.log('Customer page: Default start date loaded:', defaultStartDate);
        }
      } catch (error) {
        console.error('Customer page: Error getting default start date:', error);
      }
    }

    // Load customer data from API
    async function loadCustomerFromAPI(customerId) {
      try {
        console.log('Customer page: Fetching customer data for ID:', customerId);
        
        if (!window.electronAPI || !window.electronAPI.customer) {
          console.log('Customer page: electronAPI not available, using fallback data');
          return null;
        }
        
        const customerResult = await window.electronAPI.customer.getById(customerId);
        console.log('Customer page: Customer result:', customerResult);
        
        if (customerResult.success && customerResult.customer) {
          customerData = customerResult.customer;
          console.log('Customer page: Real customer data loaded:', customerData);
          return customerResult;
        } else {
          console.log('Customer page: Customer not found, keeping fallback data');
          return null;
        }
        
      } catch (error) {
        console.error('Customer page: Error loading customer from API:', error);
        return null;
      }
    }

    // Load payments data from API
    async function loadPaymentsFromAPI(customerId) {
      try {
        console.log('Customer page: Fetching payments for customer ID:', customerId);
        
        if (!window.electronAPI || !window.electronAPI.customer) {
          console.log('Customer page: electronAPI not available, using empty payments');
          paymentsData = [];
          return;
        }
        
        const paymentsResult = await window.electronAPI.customer.getPayments(customerId);
        console.log('Customer page: Payments result:', paymentsResult);
        
        if (paymentsResult.success && paymentsResult.payments) {
          paymentsData = paymentsResult.payments;
          console.log('Customer page: Payments data loaded:', paymentsData.length, 'payments');
        } else {
          paymentsData = [];
          console.log('Customer page: No payments found');
        }
        
      } catch (error) {
        console.error('Customer page: Error loading payments from API:', error);
        paymentsData = [];
      }
    }

    // Refresh payment data and update UI
    async function refreshPaymentData() {
      const customerId = getCustomerIdFromUrl();
      if (customerId) {
        console.log('Customer page: Refreshing payment data for customer:', customerId);
        await loadPaymentsFromAPI(customerId);
        generatePaymentTimeline();
        updateCustomerInfo(); // Update badge status
        updateAmountCollectedCard(); // Update amount collected card
        console.log('Customer page: Payment data refreshed successfully');
      }
    }

    // Check if customer is fully paid (all payments including current month)
    function isCustomerFullyPaid() {
      if (!customerData || !paymentsData) {
        return false;
      }

      const startDate = new Date(customerData.start_date);
      const now = new Date();
      const currentMonth = now.getMonth();
      const currentYear = now.getFullYear();
      
      // Calculate how many months have passed since start date
      const monthsPassed = (currentYear - startDate.getFullYear()) * 12 + (currentMonth - startDate.getMonth()) + 1;
      
      // Create a map of payments by month-year
      const paymentsByMonth = {};
      paymentsData.forEach(payment => {
        // Use month_year field instead of payment_date to determine which month the payment is for
        const monthYear = payment.month_year; // Format: "2024-12"
        if (monthYear) {
          const [year, month] = monthYear.split('-');
          const monthKey = `${year}-${parseInt(month) - 1}`; // Convert to 0-based month index
          paymentsByMonth[monthKey] = payment;
        }
      });

      // Check if all months from start to current month are paid
      for (let i = 0; i < monthsPassed; i++) {
        const checkDate = new Date(startDate.getFullYear(), startDate.getMonth() + i, 1);
        const monthKey = `${checkDate.getFullYear()}-${checkDate.getMonth()}`;
        
        if (!paymentsByMonth[monthKey]) {
          return false; // Found an unpaid month
        }
      }

      return true; // All months are paid
    }

    // Update customer information in UI
    function updateCustomerInfo() {
      if (!customerData) {
        console.error('No customer data available');
        return;
      }

      console.log('Updating customer info with data:', customerData);

      // Update customer name
      const customerNameEl = document.getElementById('customerName');
      if (customerNameEl) {
        customerNameEl.textContent = customerData.name || 'Unknown Customer';
      }

      // Update customer address
      const customerAddressEl = document.getElementById('customerAddress');
      if (customerAddressEl) {
        const address = customerData.address;
        if (address && address.trim() !== '') {
          customerAddressEl.textContent = address;
        } else {
          customerAddressEl.textContent = 'No address provided';
          customerAddressEl.classList.add('text-slate-400', 'italic');
        }
      }

      // Update customer details
      const customerDetailsEl = document.getElementById('customerDetails');
      if (customerDetailsEl) {
        customerDetailsEl.textContent = 
          `${customerData.phone || 'No phone'} • Started on ${customerData.start_date || 'Unknown date'}`;
      }

      // Show/hide shining badge based on payment status
      const shiningBadgeEl = document.getElementById('shiningBadge');
      if (shiningBadgeEl) {
        if (isCustomerFullyPaid()) {
          shiningBadgeEl.classList.remove('hidden');
          console.log('Customer is fully paid! Showing shining badge.');
        } else {
          shiningBadgeEl.classList.add('hidden');
        }
      }

      // Update Add Payment button with customer ID
      const addPaymentBtn = document.getElementById('addPaymentBtn');
      if (addPaymentBtn && customerData) {
        addPaymentBtn.href = `add-payment.html?id=${customerData.id}`;
      }
      
      // Update monthly amount (without animation)
      const monthlyAmountEl = document.getElementById('monthlyAmount');
      if (monthlyAmountEl) {
        const amount = customerData.monthly_amount || 0;
        monthlyAmountEl.textContent = `₹ ${amount.toLocaleString('en-IN')}`;
      }
      
      // Update program details
      const programDetailsEl = document.getElementById('programDetails');
      if (programDetailsEl) {
        const startDate = new Date(customerData.start_date);
        const monthNames = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
        const startMonth = `${monthNames[startDate.getMonth()]} ${startDate.getFullYear()}`;
        
        programDetailsEl.textContent = `Program started ${startMonth} • 30 months`;
      }
      
      // Update timeline title
      const timelineTitleEl = document.getElementById('timelineTitle');
      if (timelineTitleEl) {
        const startDate = new Date(customerData.start_date);
        const monthNames = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
        const startMonth = `${monthNames[startDate.getMonth()]} ${startDate.getFullYear()}`;
        
        timelineTitleEl.textContent = `30-Month Payment Timeline (${startMonth} →)`;
      }
    }

    // Update amount collected card with count-up animation
    function updateAmountCollectedCard() {
      if (!paymentsData || paymentsData.length === 0) {
        document.getElementById('totalAmountCollected').textContent = '₹ 0';
        document.getElementById('paymentCount').textContent = '0 payments';
        return;
      }

      // Calculate total amount collected
      const totalAmount = paymentsData.reduce((sum, payment) => {
        return sum + (parseFloat(payment.amount) || 0);
      }, 0);

      // Update the card with count-up animation
      const totalAmountEl = document.getElementById('totalAmountCollected');
      const paymentCountEl = document.getElementById('paymentCount');
      
      if (totalAmountEl) {
        // Get current displayed amount
        const currentText = totalAmountEl.textContent;
        const currentAmount = parseInt(currentText.replace(/[₹,\s]/g, '')) || 0;
        
        // Animate from current amount to new amount
        animateCountUp(totalAmountEl, currentAmount, totalAmount);
      }
      
      if (paymentCountEl) {
        const count = paymentsData.length;
        paymentCountEl.textContent = `${count} payment${count !== 1 ? 's' : ''}`;
      }
    }

    // Animate count-up from start to end value
    function animateCountUp(element, startValue, endValue) {
      const duration = 1000; // 1 second
      const startTime = performance.now();
      
      function updateCount(currentTime) {
        const elapsed = currentTime - startTime;
        const progress = Math.min(elapsed / duration, 1);
        
        // Easing function for smooth animation
        const easeOutQuart = 1 - Math.pow(1 - progress, 4);
        const currentValue = Math.floor(startValue + (endValue - startValue) * easeOutQuart);
        
        // Update the display
        element.textContent = `₹ ${currentValue.toLocaleString('en-IN')}`;
        
        // Add animation class for visual feedback
        element.classList.add('amount-counting');
        setTimeout(() => {
          element.classList.remove('amount-counting');
        }, 100);
        
        // Continue animation if not finished
        if (progress < 1) {
          requestAnimationFrame(updateCount);
        }
      }
      
      requestAnimationFrame(updateCount);
    }

    // Generate payment timeline based on real data
    function generatePaymentTimeline() {
      const container = document.getElementById('calendarGrid');
      if (!container || !customerData) {
        console.error('Container or customer data not available');
        return;
      }
      
      container.innerHTML = ''; // Clear loading message
      
      const startDate = new Date(customerData.start_date);
      const count = 30; // Always show 30 months
      const monthNames = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
      const now = new Date();
      
      console.log('Generating timeline for customer:', customerData.name, 'Starting from:', startDate);
      console.log('Payments data:', paymentsData);
      
      // Create a map of payments by month-year for quick lookup
      const paymentsByMonth = {};
      paymentsData.forEach(payment => {
        // Use month_year field instead of payment_date to determine which month the payment is for
        const monthYear = payment.month_year; // Format: "2024-12"
        if (monthYear) {
          const [year, month] = monthYear.split('-');
          const monthKey = `${year}-${parseInt(month) - 1}`; // Convert to 0-based month index
          paymentsByMonth[monthKey] = payment;
        }
      });

      console.log('Payments by month:', paymentsByMonth);

      for (let i = 0; i < count; i++) {
        const monthDate = new Date(startDate.getFullYear(), startDate.getMonth() + i, 1);
        const monthKey = `${monthDate.getFullYear()}-${monthDate.getMonth()}`;
        const payment = paymentsByMonth[monthKey];
        
        const monthLabel = `${monthNames[monthDate.getMonth()]} ${monthDate.getFullYear()} - ${i+1}`;
        const isCurrent = monthDate.getFullYear() === now.getFullYear() && monthDate.getMonth() === now.getMonth();
        const isPaid = !!payment;
        const isPastMonth = monthDate < now;
        const isFutureMonth = monthDate > now;

        console.log(`Month ${i+1}: ${monthLabel}, Paid: ${isPaid}, Current: ${isCurrent}, Past: ${isPastMonth}, Future: ${isFutureMonth}`);

        // Icons
        const cashSvg = '<svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="currentColor"><path d="M3 6h18v12H3z" opacity=".3"/><path d="M21 5H3a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h18a1 1 0 0 0 1-1V6a1 1 0 0 0-1-1m-1 12H4v-2a2 2 0 0 0 2-2 2 2 0 0 0-2-2V7h16v2a2 2 0 0 0-2 2 2 2 0 0 0 2 2z"/></svg>';
        const gpaySvg = '<svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" viewBox="0 0 48 48"><path fill="#34a853" d="M24 9.5c3.7 0 6.3 1.6 7.8 3l5.3-5.1C33.7 4.7 29.3 3 24 3 14.8 3 6.9 8.3 3.3 16l6.8 5.3C12 15 17.5 9.5 24 9.5z"/><path fill="#4285f4" d="M46.5 24.5c0-1.6-.1-2.8-.4-4.1H24v7.8h12.8c-.3 2.1-1.8 5.3-5.3 7.5l8.2 6.3c4.8-4.4 7.8-10.9 7.8-17.5z"/><path fill="#fbbc05" d="M10.1 28.7A14.5 14.5 0 0 1 9.3 24c0-1.6.3-3.1.8-4.5L3.3 14C1.8 17.3 1 20.6 1 24s.8 6.7 2.3 10l6.8-5.3z"/><path fill="#ea4335" d="M24 47c6.5 0 12-2.1 16-5.8l-8.2-6.3c-2.2 1.5-5.2 2.6-7.8 2.6-6.5 0-12-5.5-13.9-12.8l-6.8 5.3C6.9 39.7 14.8 47 24 47z"/></svg>';

        // Status chips - show "Paid" for any month with payment, "Unpaid" only for past months (not for winners)
        let statusChip = '';
        if (isPaid) {
          // Show "Paid" for any month that has a payment (past, current, or future)
          statusChip = '<span class="inline-flex items-center rounded-full bg-green-100 text-green-800 px-2 py-0.5 text-xs font-medium">Paid</span>';
        } else if (isPastMonth && !currentWinner) {
          // Only show "Unpaid" for past months that are actually due, but NOT for winners
          statusChip = '<span class="inline-flex items-center rounded-full bg-red-100 text-red-800 px-2 py-0.5 text-xs font-medium">Unpaid</span>';
        }
        // For future months without payment, or for winners, no status chip is shown

        let meta = '';
        if (isPaid) {
          // Show payment details for any month that has a payment (including advance payments)
          const paymentDate = new Date(payment.payment_date);
          const methodIsGpay = payment.payment_method && payment.payment_method.toLowerCase().includes('gpay');
          
          meta = `<div class="mt-2 text-[11px] text-slate-600">
                   <div class="inline-flex items-center gap-2">
                     <span class="inline-flex items-center gap-1 ${methodIsGpay ? 'text-blue-600' : 'text-emerald-700'}">
                       ${methodIsGpay ? gpaySvg : cashSvg}
                       <span>${methodIsGpay ? 'GPay' : 'Cash'}</span>
                     </span>
                     <span class="text-slate-400">•</span>
                     <span>${paymentDate.getDate()} ${monthNames[paymentDate.getMonth()]} ${paymentDate.getFullYear()}</span>
                   </div>
                   ${payment.transaction_id ? `<div class="mt-1 text-[10px] text-slate-500 font-mono">TXN: ${payment.transaction_id}</div>` : ''}
                 </div>`;
        } else if (isPastMonth && !currentWinner) {
          // Only show "Due" for past months without payment, but NOT for winners
          meta = `<div class="mt-2 text-[11px] text-slate-400 inline-flex items-center gap-1">
               <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="currentColor"><path d="M7 2v2H5a2 2 0 0 0-2 2v1h18V6a2 2 0 0 0-2-2h-2V2h-2v2H9V2z"/><path d="M21 9H3v9a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2zm-4 4h-4v4h4z" opacity=".4"/></svg>
               <span>Due</span>
             </div>`;
        }
        // For future months without payment, or for winners, no meta information is shown

        const currentBadge = isCurrent
          ? '<span class="absolute -top-2 -right-2 text-[10px] px-1.5 py-0.5 rounded-full bg-red-700 text-white ring-1 ring-red-800 font-medium">Current</span>'
          : '';

        // Card styling based on status
        let cardBorderColor = 'border-slate-200'; // Default for future months without payment
        if (isPaid) {
          // Green border for any month with payment (including advance payments)
          cardBorderColor = 'border-green-200';
        } else if (isPastMonth) {
          // Red border for past months without payment
          cardBorderColor = 'border-red-200';
        }

        const tile = document.createElement('div');
        tile.className = 'relative group rounded-xl';
        
        // Add tooltip class and data if payment has notes
        let tooltipClass = '';
        let tooltipData = '';
        if (isPaid && payment.notes && payment.notes.trim()) {
          tooltipClass = 'payment-tooltip';
          tooltipData = `data-tooltip="${payment.notes}"`;
        }
        
        tile.innerHTML = `
          <div class="bg-white rounded-xl p-4 border ${isCurrent ? 'border-red-700' : cardBorderColor} shadow-card h-[130px] w-full hover:shadow-lg transition-shadow duration-200 ${tooltipClass}" ${tooltipData}>
            <div class="flex flex-col h-full">
              ${currentBadge}
              <div class="flex items-center justify-between mb-2">
                <div class="font-medium text-slate-800">${monthLabel}</div>
                ${statusChip}
              </div>
              <div class="flex-1 flex items-end">
                ${meta}
              </div>
            </div>
          </div>`;
        container.appendChild(tile);
      }
      
      console.log(`Generated ${count} month tiles for customer timeline`);
      
      // Update shining badge after timeline is generated
      const shiningBadgeEl = document.getElementById('shiningBadge');
      if (shiningBadgeEl) {
        if (isCustomerFullyPaid()) {
          shiningBadgeEl.classList.remove('hidden');
          console.log('Customer is fully paid! Showing shining badge.');
        } else {
          shiningBadgeEl.classList.add('hidden');
        }
      }
    }

    // Show error message
    function showError(message) {
      const container = document.getElementById('calendarGrid');
      if (container) {
        container.innerHTML = `<div class="col-span-full text-center py-8 text-red-500">${message}</div>`;
      }
    }


    // Smooth navigation
    (function() {
      const prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
      function fadeNavigate(event, href) {
        if (prefersReduced) return;
        event.preventDefault();
        document.body.classList.add('opacity-0');
        setTimeout(() => { window.location.href = href; }, 180);
      }
      document.addEventListener('click', function(e) {
        const a = e.target.closest('a[href]');
        if (!a) return;
        const url = new URL(a.href, window.location.href);
        const sameOrigin = url.origin === window.location.origin;
        if (sameOrigin) fadeNavigate(e, a.href);
      });
    })();

    // Initialize page - SIMPLE AND BULLETPROOF
    document.addEventListener('DOMContentLoaded', function() {
      console.log('Customer page: DOM loaded, initializing...');
      
      // Show customer data immediately (with loading state)
      showCustomerData();
      
      // Load real customer data from database
      loadCustomerData();
      
      
      // Add hover effects
      addHoverEffects();
      
      // Add page visibility change listener to refresh data when returning from other pages
      document.addEventListener('visibilitychange', function() {
        if (!document.hidden) {
          console.log('Customer page: Page became visible, refreshing payment data...');
          refreshPaymentData();
        }
      });

      // Also refresh when window gains focus (for better cross-browser support)
      window.addEventListener('focus', function() {
        console.log('Customer page: Window gained focus, refreshing payment data...');
        refreshPaymentData();
      });
      
      console.log('Customer page: Initialization completed');
    });


    // Add hover effects to timeline tiles
    function addHoverEffects() {
      setTimeout(() => {
        document.querySelectorAll('#calendarGrid > div').forEach(tile => {
          tile.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-2px)';
            this.style.transition = 'transform 0.3s ease';
          });
          
          tile.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
          });
        });
      }, 100);
    }

    // Winner functionality
    let currentCustomerId = null;
    let currentWinner = null;

    // Load customer winner status
    async function loadCustomerWinner() {
      console.log('loadCustomerWinner called, currentCustomerId:', currentCustomerId);
      if (!currentCustomerId) {
        console.log('No currentCustomerId, returning');
        return;
      }
      
      try {
        console.log('Calling winners.getAll()');
        const result = await window.electronAPI.winners.getAll();
        console.log('Winners result:', result);
        if (result.success) {
          const customerWinner = result.winners.find(w => w.customer_id === currentCustomerId);
          console.log('Customer winner found:', customerWinner);
          if (customerWinner) {
            currentWinner = customerWinner;
            showWinnerBadge(customerWinner);
            loadWinnerDetails(customerWinner);
          } else {
            hideWinnerElements();
            showMarkWinnerButton();
          }
        }
      } catch (error) {
        console.error('Error loading customer winner:', error);
      }
    }

    // Show winner badge
    function showWinnerBadge(winner) {
      const winnerBadge = document.getElementById('winnerBadge');
      const winnerPosition = document.getElementById('winnerPosition');
      const markWinnerBtn = document.getElementById('markWinnerBtn');
      const addPaymentBtn = document.getElementById('addPaymentBtn');
      const customerInfoSection = document.getElementById('customerInfoSection');
      const timelineSection = document.getElementById('timelineSection');
      const timelineLegend = document.getElementById('timelineLegend');
      const totalCollectedCard = document.querySelector('.relative.overflow-hidden.rounded-xl.bg-gradient-to-br.from-brand-500');
      
      if (winnerBadge && winnerPosition) {
        winnerPosition.textContent = `${winner.position}${getOrdinalSuffix(winner.position)} Winner`;
        winnerBadge.classList.remove('hidden');
        if (markWinnerBtn) markWinnerBtn.classList.add('hidden');
      }
      
      // Hide customer info section (monthly amount and add payment button) for winners
      if (customerInfoSection) {
        customerInfoSection.classList.add('hidden');
      }
      
      // Hide total collected card for winners
      if (totalCollectedCard) {
        totalCollectedCard.classList.add('hidden');
      }
      
      // Disable timeline section for winners
      if (timelineSection) {
        timelineSection.classList.add('opacity-50', 'pointer-events-none');
      }
      
      // Hide timeline legend for winners
      if (timelineLegend) {
        timelineLegend.classList.add('hidden');
      }
    }

    // Hide winner elements
    function hideWinnerElements() {
      const winnerBadge = document.getElementById('winnerBadge');
      const winnerDetailsCard = document.getElementById('winnerDetailsCard');
      const markWinnerBtn = document.getElementById('markWinnerBtn');
      const addPaymentBtn = document.getElementById('addPaymentBtn');
      const customerInfoSection = document.getElementById('customerInfoSection');
      const timelineSection = document.getElementById('timelineSection');
      const timelineLegend = document.getElementById('timelineLegend');
      const totalCollectedCard = document.querySelector('.relative.overflow-hidden.rounded-xl.bg-gradient-to-br.from-brand-500');
      
      if (winnerBadge) winnerBadge.classList.add('hidden');
      if (winnerDetailsCard) winnerDetailsCard.classList.add('hidden');
      if (markWinnerBtn) markWinnerBtn.classList.add('hidden');
      
      // Show customer info section for non-winners
      if (customerInfoSection) {
        customerInfoSection.classList.remove('hidden');
      }
      
      // Show total collected card for non-winners
      if (totalCollectedCard) {
        totalCollectedCard.classList.remove('hidden');
      }
      
      // Re-enable timeline section for non-winners
      if (timelineSection) {
        timelineSection.classList.remove('opacity-50', 'pointer-events-none');
      }
      
      // Show timeline legend for non-winners
      if (timelineLegend) {
        timelineLegend.classList.remove('hidden');
      }
      
      // Re-enable Add Payment button for non-winners
      if (addPaymentBtn) {
        addPaymentBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        addPaymentBtn.onclick = null;
        addPaymentBtn.removeAttribute('title');
      }
    }

    // Show mark winner button
    function showMarkWinnerButton() {
      console.log('showMarkWinnerButton called');
      const markWinnerBtn = document.getElementById('markWinnerBtn');
      if (markWinnerBtn) {
        markWinnerBtn.classList.remove('hidden');
        console.log('Mark winner button shown');
      } else {
        console.log('Mark winner button not found');
      }
    }

    // Get ordinal suffix
    function getOrdinalSuffix(num) {
      const j = num % 10;
      const k = num % 100;
      if (j === 1 && k !== 11) return 'st';
      if (j === 2 && k !== 12) return 'nd';
      if (j === 3 && k !== 13) return 'rd';
      return 'th';
    }

    // Load winner details
    async function loadWinnerDetails(winner) {
      const winnerDetailsCard = document.getElementById('winnerDetailsCard');
      const winnerTitle = document.getElementById('winnerTitle');
      const winnerMonthYear = document.getElementById('winnerMonthYear');
      const winnerGoldRate = document.getElementById('winnerGoldRate');
      const winnerAmount = document.getElementById('winnerAmount');
      const winnerTotalCollections = document.getElementById('winnerTotalCollections');
      const winnerMonthlyAmount = document.getElementById('winnerMonthlyAmount');
      const winnerDelivered = document.getElementById('winnerDelivered');
      const winnerRemaining = document.getElementById('winnerRemaining');
      const deliveryCompleted = document.getElementById('deliveryCompleted');
      const deliveryPending = document.getElementById('deliveryPending');

      if (!winnerDetailsCard) return;

      // Calculate total collections from payments data
      const totalCollections = paymentsData.reduce((sum, payment) => {
        return sum + (parseFloat(payment.amount) || 0);
      }, 0);

      // Update winner details
      if (winnerTitle) winnerTitle.textContent = `${winner.position}${getOrdinalSuffix(winner.position)} Winner`;
      if (winnerMonthYear) winnerMonthYear.textContent = winner.month_year;
      if (winnerGoldRate) winnerGoldRate.textContent = `₹${winner.gold_rate}/gram`;
      if (winnerAmount) winnerAmount.textContent = `₹${winner.winning_amount}`;
      if (winnerTotalCollections) winnerTotalCollections.textContent = `₹${totalCollections.toLocaleString('en-IN')}`;
      if (winnerMonthlyAmount && customerData) winnerMonthlyAmount.textContent = `₹${customerData.monthly_amount.toLocaleString('en-IN')}`;
      if (winnerDelivered) winnerDelivered.textContent = `₹${winner.delivered_amount || 0} / ₹${winner.winning_amount}`;

      // Update remaining balance
      const remainingBalance = winner.winning_amount - (winner.delivered_amount || 0);
      if (winnerRemaining) winnerRemaining.textContent = `₹${remainingBalance.toLocaleString('en-IN')}`;

      // Update delivery status and show/hide Add Delivery button
      const addDeliveryBtn = document.getElementById('addDeliveryBtn');
      if (remainingBalance <= 0) {
        if (deliveryCompleted) deliveryCompleted.classList.remove('hidden');
        if (deliveryPending) deliveryPending.classList.add('hidden');
        if (addDeliveryBtn) addDeliveryBtn.classList.add('hidden');
      } else {
        if (deliveryCompleted) deliveryCompleted.classList.add('hidden');
        if (deliveryPending) deliveryPending.classList.remove('hidden');
        if (addDeliveryBtn) addDeliveryBtn.classList.remove('hidden');
      }

      winnerDetailsCard.classList.remove('hidden');
    }

    // Load available months for winner selection
    window.loadAvailableMonths = async function() {
      console.log('🚀 loadAvailableMonths: Function called!');
      
      try {
        console.log('loadAvailableMonths: Starting to load months...');
        
        // Check if modal is visible
        const modal = document.getElementById('winnerModal');
        console.log('loadAvailableMonths: Modal element:', modal);
        console.log('loadAvailableMonths: Modal classes:', modal ? modal.className : 'Modal not found');
        
        console.log('loadAvailableMonths: Calling API...');
        const result = await window.electronAPI.winners.getAvailableMonths();
        console.log('loadAvailableMonths: API result:', result);
        
        if (result.success) {
          console.log('loadAvailableMonths: Success, months array:', result.availableMonths);
          const select = document.getElementById('winnerMonthYearSelect');
          console.log('loadAvailableMonths: Select element found:', select);
          console.log('loadAvailableMonths: Select element parent:', select ? select.parentElement : 'Select not found');
          
          if (select) {
            // Clear existing options
            select.innerHTML = '';
            
            // Add default option
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = 'Select a month...';
            select.appendChild(defaultOption);
            
            console.log('loadAvailableMonths: Adding months to dropdown...');
            result.availableMonths.forEach((month, index) => {
              console.log(`loadAvailableMonths: Adding month ${index + 1}:`, month);
              const option = document.createElement('option');
              option.value = month;
              
              // Format month like dashboard: "Dec 2024 (1)"
              const [year, monthNum] = month.split('-');
              const monthNames = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
              const monthIndex = parseInt(monthNum) - 1;
              const monthName = monthNames[monthIndex];
              const monthNumber = index + 1;
              const displayText = `${monthName} ${year} (${monthNumber})`;
              
              option.textContent = displayText;
              select.appendChild(option);
            });
            
            console.log('loadAvailableMonths: Total options in select:', select.options.length);
            console.log('loadAvailableMonths: Select innerHTML:', select.innerHTML);
            
            // Force a re-render by triggering a change event
            select.dispatchEvent(new Event('change'));
            
            console.log('✅ loadAvailableMonths: Successfully populated dropdown!');
          } else {
            console.error('❌ loadAvailableMonths: Select element not found!');
          }
        } else {
          console.error('❌ loadAvailableMonths: API call failed:', result.error);
        }
      } catch (error) {
        console.error('❌ Error loading available months:', error);
      }
    };

    // Event listeners
    document.addEventListener('DOMContentLoaded', function() {
      // Mark winner button
      const markWinnerBtn = document.getElementById('markWinnerBtn');
      if (markWinnerBtn) {
        markWinnerBtn.addEventListener('click', function() {
          console.log('Mark winner button clicked');
          const modal = document.getElementById('winnerModal');
          console.log('Modal element:', modal);
          modal.classList.remove('hidden');
          console.log('Modal shown, loading months in 300ms...');
          
          // Load months after modal is fully visible and rendered
          setTimeout(() => {
            console.log('Timeout reached, calling loadAvailableMonths');
            window.loadAvailableMonths();
          }, 300);
        });
      }

      // Close winner modal
      const closeWinnerModal = document.getElementById('closeWinnerModal');
      const cancelWinner = document.getElementById('cancelWinner');
      if (closeWinnerModal) {
        closeWinnerModal.addEventListener('click', function() {
          document.getElementById('winnerModal').classList.add('hidden');
        });
      }
      if (cancelWinner) {
        cancelWinner.addEventListener('click', function() {
          document.getElementById('winnerModal').classList.add('hidden');
        });
      }

      // Winner form submission
      const winnerForm = document.getElementById('winnerForm');
      if (winnerForm) {
        winnerForm.addEventListener('submit', async function(e) {
          e.preventDefault();
          
          const formData = new FormData(winnerForm);
          const monthYear = formData.get('monthYear');
          const goldRate = parseFloat(formData.get('goldRate'));
          const winningAmount = parseFloat(formData.get('winningAmount'));
          
          if (!currentCustomerId) {
            alert('Customer not loaded');
            return;
          }

          try {
            // Find the position (count existing winners + 1)
            const result = await window.electronAPI.winners.getAll();
            let position = 1;
            if (result.success) {
              position = result.winners.length + 1;
            }

            const addResult = await window.electronAPI.winners.add({
              customerId: currentCustomerId,
              monthYear: monthYear,
              goldRate: goldRate,
              winningAmount: winningAmount,
              position: position
            });

            if (addResult.success) {
              document.getElementById('winnerModal').classList.add('hidden');
              await loadCustomerWinner();
              alert('Customer marked as winner successfully!');
            } else {
              alert('Error marking customer as winner: ' + addResult.error);
            }
          } catch (error) {
            console.error('Error marking winner:', error);
            alert('Error marking customer as winner');
          }
        });
      }

        // Gold rate and winning amount are now separate inputs

      // Add delivery button
      const addDeliveryBtn = document.getElementById('addDeliveryBtn');
      if (addDeliveryBtn) {
        addDeliveryBtn.addEventListener('click', function() {
          if (currentWinner) {
            document.getElementById('winnerId').value = currentWinner.id;
            document.getElementById('deliveryModal').classList.remove('hidden');
            updateRemainingBalance();
          }
        });
      }

      // Close delivery modal
      const closeDeliveryModal = document.getElementById('closeDeliveryModal');
      const cancelDelivery = document.getElementById('cancelDelivery');
      if (closeDeliveryModal) {
        closeDeliveryModal.addEventListener('click', function() {
          document.getElementById('deliveryModal').classList.add('hidden');
        });
      }
      if (cancelDelivery) {
        cancelDelivery.addEventListener('click', function() {
          document.getElementById('deliveryModal').classList.add('hidden');
        });
      }

      // Delivery form submission
      const deliveryForm = document.getElementById('deliveryForm');
      if (deliveryForm) {
        deliveryForm.addEventListener('submit', async function(e) {
          e.preventDefault();
          
          const formData = new FormData(deliveryForm);
          const winnerId = formData.get('winnerId');
          const billNumber = formData.get('billNumber');
          const amount = parseFloat(formData.get('deliveryAmount'));

          // Validate amount
          if (!amount || amount <= 0) {
            alert('Please enter a valid delivery amount');
            return;
          }

          try {
            const result = await window.electronAPI.deliveries.add({
              winnerId: winnerId,
              billNumber: billNumber,
              amount: amount,
              notes: ''
            });

            if (result.success) {
              document.getElementById('deliveryModal').classList.add('hidden');
              await loadCustomerWinner();
              showToast('Delivery added successfully!', 'success');
            } else {
              showToast('Error adding delivery: ' + result.error, 'error');
            }
          } catch (error) {
            console.error('Error adding delivery:', error);
            showToast('Error adding delivery: ' + error.message, 'error');
          }
        });
      }

      // Update remaining balance
      const deliveryAmountInput = document.getElementById('deliveryAmount');
      if (deliveryAmountInput) {
        deliveryAmountInput.addEventListener('input', updateRemainingBalance);
      }
    });

    // Update remaining balance in delivery modal
    function updateRemainingBalance() {
      if (!currentWinner) return;
      
      const deliveryAmountInput = document.getElementById('deliveryAmount');
      const remainingBalanceInput = document.getElementById('remainingBalance');
      
      if (deliveryAmountInput && remainingBalanceInput) {
        const deliveryAmount = parseFloat(deliveryAmountInput.value) || 0;
        const currentDelivered = currentWinner.delivered_amount || 0;
        const totalWinningAmount = currentWinner.winning_amount;
        const remainingBalance = totalWinningAmount - currentDelivered - deliveryAmount;
        
        remainingBalanceInput.value = `₹${remainingBalance}`;
        if (remainingBalance < 0) {
          remainingBalanceInput.value += ' (Over delivery!)';
        }
      }
    }

    // Update the existing updateCustomerInfo function to include winner loading
    const originalUpdateCustomerInfo = updateCustomerInfo;
    updateCustomerInfo = function() {
      console.log('updateCustomerInfo called, customerData:', customerData);
      originalUpdateCustomerInfo();
      if (customerData) {
        currentCustomerId = customerData.id;
        console.log('Set currentCustomerId to:', currentCustomerId);
        loadCustomerWinner();
      }
    };
  </script>
</body>
</html>